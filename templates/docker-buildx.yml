image: jdrouet/docker-with-buildx:stable

services:
  - docker:dind

buildx:
  stage: build_x_push
  before_script:
    - docker login -u "$DOCKER_UN" -p "$DOCKER_PW"
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  script:
    - docker buildx create --use
    - |
        [ -z "$DOCKER_REPO" ] && DOCKER_REPO="$CI_PROJECT_NAME"
        [ -z "$CI_COMMIT_TAG" ] && CI_COMMIT_TAG=test
        docker buildx build \
        --label "org.label-schema.schema-version=1.0" \
        --label "org.label-schema.build-date=$CI_PIPELINE_CREATED_AT" \
        --label "org.label-schema.vcs-ref=$CI_COMMIT_SHA" \
        --label "org.label-schema.vcs-url=https://gitlab.com/$CI_PROJECT_PATH" \
        --label "org.label-schema.name=$DOCKER_REPO" \
        --label "org.label-schema.version=$CI_COMMIT_TAG" \
        --label "alpine-version=$ALP_VER" \
        --label "org.label-schema.description=$DESC" \
        --platform linux/arm/v7,linux/arm64,linux/386,linux/amd64,linux/s390x,linux/ppc64le \
        --tag "$DOCKER_UN/$DOCKER_REPO" \
        --tag "$DOCKER_UN/$DOCKER_REPO:$CI_COMMIT_TAG" \
        --tag "$CI_REGISTRY/$CI_PROJECT_PATH":latest \
        --tag "$CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_TAG" --push .
  after_script:
    - |
        echo "{\"sha\":\"$CI_COMMIT_SHA\"}" > badges.json
  artifacts:
    paths:
        - badges.json
    when: always
  rules:
    - if: "$CI_COMMIT_TAG"
  needs:
    - job: build
      artifacts: true
